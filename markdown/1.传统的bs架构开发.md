#传统的b/s架构开发

>成钞公司印钞管理部 李宾

- - - - -
##自我介绍
李宾，07年北京印刷学院印刷工程专业，07年进入成钞公司，12年四川大学软件工程在职研究生，13年6月进入技术质量部。
<i class="fa fa-github"></i>[www.github.com/realeve]( www.github.com/realeve)
<i class="fa fa-weixin"></i>41192163

---
> 质量信息管理系统代码片断，2014年，**asp**，第一次涉足B/S架构开发。

```html
<table  style="width:720px;margin-left:24px;table-layout:fixed;align:center;cellpadding:3;cellspacing:0;">
	<tbody>
		 <%
		 strMachineTemp=""
		 nColor=2
		 Do Until rsg.Eof	
			if strMachineTemp <> rsg("机台") then
				nColor=nColor+1	
			end if
			if nColor mod 2 =1 then
				HColor="#F4F4F4"
			else
				HColor="#FFFFFF"
			end if%>
			<tr>
				<td class="FirstRow" bgcolor="<%=HColor%>"> <%=rsg("品种")%></td>
				<td bgcolor="<%=HColor%>"> <%=rsg("正反面")%></td>
				<td bgcolor="<%=HColor%>"> <%=rsg("机长")%></td>
				<td bgcolor="<%=HColor%>"> <%=rsg("总张数_技质")%></td>
				<td bgcolor="<%=HColor%>"> <%=rsg("平均得分_技质")%></td>				
				<td bgcolor="<%=HColor%>"> <%=rsg("总张数_质检员")%></td>
				<td bgcolor="<%=HColor%>"> <%=rsg("总张数_机台")%></td>
				<td class="LastRow"  bgcolor="<%=HColor%>">
    				 <%if rsg("标准偏差_机台")<1 then%>0<%end if%>
    				 <%=rsg("标准偏差_机台")%>
				 </td>
			</tr>					
		<%
		strMachineTemp=rsg("机台")
		rsg.MoveNext
		Loop%>
	</tbody>
</table>
```

- - - - -
#常见问题
1.模块化程度低
菜单：页面间菜单的复用
报表：所有报表需要手动定义thead,tbody

2.逻辑与页面视图高度耦合，后期维护困难
3.样式直接写在html中，未使用css管理样式
4.部分页面使用table定位布局，对于当时已兴起的html5技术尚未涉及
>在过去10年，以asp**快速实现功能**的开发模式成为了许多初学者的首选，在后续的深入开发中可能都会遇到这样的一些问题，此时具代表性的开发软件主要是dreamware.
- - - - -
> “PHP是世界上最好的语言”

```php
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <!-- css 文件引用 -->
    <?php include "templates/style.php";?>
</head>
<body>
    <!-- 头部 -->
    <?php include "templates/header.php";?>

    <!-- 侧边菜单 -->
    <?php include "templates/sidebar_menu.php";?>

    <!-- 页面主体 -->
    <?php include "templates/content.php";?>

    <!-- 底部，同时包含必要的js文件 -->
    <?php include "templates/footer.php";?>
</body>
</html>
```
- - - - -
#PHP
>2016年开始重构成钞公司质量信息平台，以php为服务端，解决了模块化的问题。

目前PHP是应用最为广泛的服务端语言，因为简单易学成为了许多开发者的首选语言。在应用较广的PHP框架中主要有ThinkPHP(对国内主流虚拟云主机支持较好：阿里云，新浪云)、CodeIgniter(轻量、简单)、Larvel(社区目前发展最活跃)等。

在用php开发的过程中，逐渐对mvc/mvp有了学习和认识，更多技术细节推荐阅读这篇文章：[MVC，MVP 和 MVVM 的图示](http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html)

- - - - -
#Server Side Rendering 服务端渲染(SSR)
>不管是用asp/php/java作为服务端，我们把这种**通过服务器直接生成html文本**输出至浏览器的方案统称为服务端渲染。其最大的特点是查看网页源码时能看到页面所有的dom元素的html文本。

在印制行业中有许多应用的功能是以数据或报表为主，点击**查询**按钮后，整个系统将经历以下过程：
1. 浏览器端/客户端/前端发起查询请求，http Request;
2. 服务端根据前端请求，连接数据库，发起SQL请求并等待数据库返回结果；
3. 服务端对返回的数据拼凑 Table 的 HTML 文本返回前台;
4. 前台读取html内容，并请求css/js/font/img等资源，同时将结果渲染。
- - - - -
# 网页渲染过程中的网络请求
![](./image/01.png)
- - - - -
# 系统为什么这么慢？
同样以行业中的各类报表系统为例，要保证系统运行速度，需要在以下几个方面做优化：
1. 数据库优化，部分系统甚至未建议表单索引（钞纸机检系统本地数据存储）；
2. 服务端缓存，几乎都没做；
3. 减少资源请求频次，但SSR中的每一次请求都需要重新重新请求资源；
4. 浏览器渲染时间的消耗。比如8000行数据的报表，如何快速渲染(采用数据分页分增加数据请求次数)；
- - - - -
# 前端渲染
为了减少页面渲染中(前后台)的不必要时间消耗，前端渲染的方案开始应用，这也得益于[ ajax ](https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX)的出现。
> ajax实现了在页面**不刷新**的情况下前台页面同后端获取数据的能力。

延伸阅读：[JSON](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON) 、[ ajax ](https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX)
- - - - -
# 页面局部刷新
```js
$.ajax({
    url: './yourAPI',
    type: 'GET',
    dataType: 'json'
  })
  .done(function(data) {
    var tbodyStr = data.map(tdData => {
      var tdStr = tdData.map(item => `<td>${item}</td>`).join('');
      return `<tr>${tdStr}</tr>`;
    }).join('');
    $('#yourTable tbody').html(tbodyStr);
  });
```
jQuery的出现为开发者解决了页面兼容性的问题，在用户交互事件中，系统从后台获取数据并实现**页面局部刷新**，极大提升了用户体验。
此时后端

